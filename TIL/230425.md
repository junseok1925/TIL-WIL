## ì˜¤ëŠ˜ í•´ì•¼í•  ê²ƒ âœ…

- ê²Œì‹œë¬¼ ë°± êµ¬í˜„ í”„ë¡œì íŠ¸ì— cookiepaser, jwt, middleware í™œìš©í•´ì„œ ë¡œê·¸ì¸ íšŒì›ê°€ì… êµ¬í˜„
- ë¡œê·¸ì¸ì‹œ ë°œê¸‰ëœ í† í°ìœ¼ë¡œ ì‚¬ìš©ì ì¸ì¦ì—†ì´ ê²Œì‹œë¬¼ë“±ë¡,ìˆ˜ì •,ì‚­ì œ,ì¡°íšŒ,ìƒì„¸ì¡°íšŒ
- ëŒ“ê¸€ ë“±ë¡,ì¡°íšŒ,ìˆ˜ì •,ì‚­ì œ êµ¬í˜„

## ì˜¤ëŠ˜ í•™ìŠµëª©í‘œ âœï¸

- ì˜¤ëŠ˜ í• ì¼ ê¼­ ë§ˆì¹˜ê¸°

## auth-middleware.js

```jsx
const jwt = require("jsonwebtoken");
const User = require("../schemas/user");

module.exports = async (req, res, next) => {
    const { Authorization } = req.cookies;
    // Bearer qweqweqe.qweqweqw.qweqweq
    //authorizationê°€ ì¡´ì¬í•˜ì§€ ì•Šì•˜ì„ë•Œë¥¼ ëŒ€ë¹„
    // null ë³‘í•© ë¬¸ìì—´ : ì™¼ìª½ì˜ ê°’ì´ ë¹„ì—ˆê±°ë‚˜ nullì¼ ê²½ìš° ì˜¤ë¥¸ìª½ ê°’ìœ¼ë¡œ ëŒ€ì¹˜í•´ì¤€ë‹¤
    const [authType, authToken] = (Authorization ?? "").split(" ");

  //authType === Bearerê°’ì¸ì§€ í™•ì¸
  //authToken ê²€ì¦
  if (!authToken || authType !== "Bearer") {
      res.status(400).json({
      errorMessage: "ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.",
    });
    return; // ë” ì´ìƒ ë‹¤ìŒ ì½”ë“œë¡œ ì§„í–‰ ë§‰ê¸°ìœ„í•´ ë¦¬í„´
  }

  // 1. authTokenì´ ë§Œë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
  // 2. authTokenì´  ì„œë²„ê°€ ë°œê¸‰ í† í°ì´ ë§ëŠ”ì§€ ê²€ì¦
  // 3. authTokenì— ìˆëŠ” userIdì— í•´ë‹¹í•˜ëŠ” ì‚¬ìš©ìê°€ ì‹¤ì œ DBì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸

  //J WT ê²€ì¦
  try {
    // 1. authTokenì´ ë§Œë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
    // 2. authTokenì´  ì„œë²„ê°€ ë°œê¸‰ í† í°ì´ ë§ëŠ”ì§€ ê²€ì¦
    const { userId } = jwt.verify(authToken, "customized-secret-key");

    // 3. authTokenì— ìˆëŠ” userIdì— í•´ë‹¹í•˜ëŠ” ì‚¬ìš©ìê°€ ì‹¤ì œ DBì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    const user = await User.findById(userId);
    // í˜„ì¬ ì´ ë¯¸ë“¤ì›¨ì–´ ë‹¤ìŒìœ¼ë¡œ ë„˜ê¸°ê¸° ìœ„í•´ì„œ ìš°ì„  localsì•ˆì—ë‹¤ê°€ ìœ ì €ì •ë³´ë¥¼ ì „ë‹¬í•œë‹¤
    res.locals.user = user;
    next(); // ì´ ë¯¸ë“¤ì›¨ì–´ ë‹¤ìŒìœ¼ë¡œ ë³´ë‚¸ë‹¤
  } catch (error) {
    console.error(error);
    res.status(400).json({errorMessage: "ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤."});
    return;
  }
};
```

### auth.js

```jsx
//================================ ë¡œê·¸ì¸ API //================================
// ë¡œê·¸ì¸ì´ë©´ getì„ ì“°ëŠ”ê²Œ ë§ì§€ ì•ŠëŠ”ê°€? 
// -> ëª¨ë“  getë©”ì„œë“œë¡œ ë³´ë‚´ëŠ” apiëŠ” ì „ë¶€ ë‹¤ ì£¼ì†Œì— í•´ë‹¹í•˜ëŠ” ë°ì´í„°ê°€ ë…¸ì¶œì´ ë˜ê²Œ ë˜ëŠ” ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆë‹¤
// ê·¸ë˜ì„œ ë³´ì•ˆì ìœ¼ë¡œë„ postê°€ ë” ì¢‹ë‹¤
// ê·¸ë¦¬ê³  ì¸ì¦ì •ë³´ë¥¼ ìƒì„±í•´ì„œ ë°›ì•„ì˜¨ë‹¤ëŠ” ë‚´ìš©ì´ê¸° ë–„ë¬¸ì— postê°€ ë” ì í•©í•˜ë‹¤.
router.post('/auth', async (req,res) => {
    const {nickname, password } = req.body;

    // ì´ë©”ì¼ì´ ì¼ì¹˜í•˜ëŠ” userë¥¼ ì°¾ëŠ”ë‹¤.
    const user = await User.findOne({ nickname });

    // #412 í•´ë‹¹í•˜ëŠ” ìœ ì €ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°
    if(!user || user.password !== password){
        res.status(400).json({
            errMessage: "ë‹‰ë„¤ì„ ë˜ëŠ” íŒ¨ìŠ¤ì›Œë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”."
        });
        return;
    }
    // JWT ìƒì„±í•˜ê¸°
    // userIdì— DBì˜ userIdë¥¼ í• ë‹¹, ë¹„ë°€í‚¤ëŠ” "customized-secret-key" ì´ë‹¤.
    const token = jwt.sign({userId : user.userId}, "customized-secret-key");

    // tokenê°’ì„ Bearerí˜•íƒœë¡œ "Authorization"ì´ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ ì „ë‹¬
    res.cookie("Authorization", `Bearer ${token}`);
    res.status(200).json({token});
});
```

## GitHub ğŸ“˜

- https://github.com/junseok1925/Node.js_Board_backEnd
- https://github.com/junseok1925/TIL-WIL