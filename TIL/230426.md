## ì˜¤ëŠ˜ í•´ì•¼í•  ê²ƒ âœ…

- ê²Œì‹œë¬¼ ë°± êµ¬í˜„ í”„ë¡œì íŠ¸ì— cookiepaser, jwt, middleware í™œìš©í•´ì„œ ë¡œê·¸ì¸ íšŒì›ê°€ì… êµ¬í˜„
- ë¡œê·¸ì¸ì‹œ ë°œê¸‰ëœ í† í°ìœ¼ë¡œ ì‚¬ìš©ì ì¸ì¦ì—†ì´ ê²Œì‹œë¬¼ë“±ë¡,ìˆ˜ì •,ì‚­ì œ,ì¡°íšŒ,ìƒì„¸ì¡°íšŒ
- ëŒ“ê¸€ ë“±ë¡,ì¡°íšŒ,ìˆ˜ì •,ì‚­ì œ êµ¬í˜„
- â†’ ëª¨ë‘ ì™„ë²½í•˜ê²Œ êµ¬í˜„ í›„ ì˜ˆì™¸ì²˜ë¦¬ ì¡°ê±´ë¬¸ ë‹¤ì‹œ ì‘ì„±í•˜ê¸°

## ì˜¤ëŠ˜ í•™ìŠµëª©í‘œ âœï¸

- ì˜¤ëŠ˜ í• ì¼ ê¼­ ë§ˆì¹˜ê¸°

## ì˜¤ë¥˜

- user.js schemaíŒŒì¼ì— íšŒì›ê°€ì…ì‹œ ì •ê·œí™” ì¡°ê±´ì„ ì‘ì„± í–ˆì—ˆìŒ
- ëª¨ë“  ê¸°ëŠ¥ êµ¬í˜„ í›„ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ëŠ”ë° ì •ê·œí™”ê°€ ì œëŒ€ë¡œ  ì‘ë™ë˜ì§€ì•ŠìŒ

```
// /schemas/user.js

const UserSchema = new mongoose.Schema({
  nickname: {
    type: String,
    minlength: 3,
    required: true,
    match: /^[a-zA-Z0-9]+$/,
    // " ^ " : ë¬¸ìì—´ì˜ ì‹œì‘
    // " [a-zA-Z0-9] " : ì•ŒíŒŒë²³ ëŒ€/ì†Œë¬¸ì ë˜ëŠ” ìˆ«ì ì¤‘ í•˜ë‚˜ë¥¼ ë‚˜íƒ€ë‚´ëŠ” ë¬¸ì
    // " + " : í•˜ë‚˜ ì´ìƒì˜ ë¬¸ìë¥¼ ë‚˜íƒ€ë‚´ëŠ” ìˆ˜ëŸ‰ì
    // " $ " : ë¬¸ìì—´ì˜ ë
  },
  password: {
    type: String,
    minlength: 4,
    required: true,
  },
});
```

- ì°¾ì•„ë³´ë‹ˆ ì§ì ‘ router íŒŒì¼ì— ì§ì ‘ apië¥¼ ì‘ì„±ì‹œ ì¡°ê±´ë¬¸ìœ¼ë¡œ ì •ê·œí™”ë¥¼ ê±¸ì–´ì•¼ì§€ ì •ìƒì‘ë™ëœë‹¤í•¨

```jsx
// /routes/user.js

router.post('/users', async (req, res) => {
  try {
    const { nickname, password, confirmPassword } = req.body;
    // # 412 ë‹‰ë„¤ì„ í˜•ì‹ì´ ë¹„ì •ìƒì¸ ê²½ìš°
    if (!/^[a-zA-Z0-9]+$/.test(nickname) || nickname.length < 3) {
      return res.status(412).json({
        errorMessage: 'ë‹‰ë„¤ì„ì˜ í˜•ì‹ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
      });
    }

    // # 412 password í˜•ì‹ì´ ë¹„ì •ìƒì¸ ê²½ìš°
    if (password.length < 4) {
      return res.status(412).json({
        errorMessage: 'íŒ¨ìŠ¤ì›Œë“œ í˜•ì‹ì´ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
      });
    }

    // # 412 passwordì— nicknameì´ í¬í•¨ë˜ì–´ìˆëŠ” ê²½ìš°
    if (password.includes(nickname)) {
      return res.status(412).json({
        errorMessage: 'íŒ¨ìŠ¤ì›Œë“œì— ë‹‰ë„¤ì„ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
      });
    }

    // # 412 passwordì™€ confirmPasswordê°€ ì¼ì¹˜í•˜ì§€ì•ŠëŠ” ê²½ìš°
    if (password !== confirmPassword) {
      return res.status(412).json({
        errorMessage: 'íŒ¨ìŠ¤ì›Œë“œê°€ íŒ¨ìŠ¤ì›Œë“œ í™•ì¸ë€ê³¼ ë‹¤ë¦…ë‹ˆë‹¤.',
      });
    }

    // #412 nicknameì´ ì¤‘ë³µëœ ê²½ìš°
    const existsUsers = await User.findOne({nickname});
    if (existsUsers) {
      return res.status(412).json({
        errorMessage: 'ì¤‘ë³µëœ ë‹‰ë„¤ì„ì…ë‹ˆë‹¤.',
      });
    }

    const user = new User({ nickname, password });
    await user.save();

    res.status(201).json({ message: 'íšŒì›ê°€ì…ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤.' });

    // #400 ì˜ˆì™¸ ì¼€ì´ìŠ¤ì—ì„œ ì²˜ë¦¬í•˜ì§€ ëª»í•œ ì—ëŸ¬
  } catch (error) {
    console.error(error);
    res.status(400).json({
      errorMessage: 'ìš”ì²­í•œ ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
    });
  }
});
});
```

## JWT í† í° í™œìš©í•˜ê¸°

```jsx
const jwt = require("jsonwebtoken");
const User = require("../schemas/user");

module.exports = async (req, res, next) => {
    const { Authorization } = req.cookies;
    // Bearer qweqweqe.qweqweqw.qweqweq
    //authorizationê°€ ì¡´ì¬í•˜ì§€ ì•Šì•˜ì„ë•Œë¥¼ ëŒ€ë¹„
    // null ë³‘í•© ë¬¸ìì—´ : ì™¼ìª½ì˜ ê°’ì´ ë¹„ì—ˆê±°ë‚˜ nullì¼ ê²½ìš° ì˜¤ë¥¸ìª½ ê°’ìœ¼ë¡œ ëŒ€ì¹˜í•´ì¤€ë‹¤
    const [authType, authToken] = (Authorization ?? "").split(" ");

  //authType === Bearerê°’ì¸ì§€ í™•ì¸
  //authToken ê²€ì¦
  if (!authToken || authType !== "Bearer") {
      res.status(403).json({
      errorMessage: "ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.",
    });
    return; // ë” ì´ìƒ ë‹¤ìŒ ì½”ë“œë¡œ ì§„í–‰ ë§‰ê¸°ìœ„í•´ ë¦¬í„´
  }

  // 1. authTokenì´ ë§Œë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
  // 2. authTokenì´  ì„œë²„ê°€ ë°œê¸‰ í† í°ì´ ë§ëŠ”ì§€ ê²€ì¦
  // 3. authTokenì— ìˆëŠ” userIdì— í•´ë‹¹í•˜ëŠ” ì‚¬ìš©ìê°€ ì‹¤ì œ DBì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸

  //J WT ê²€ì¦
  try {
    // 1. authTokenì´ ë§Œë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸
    // 2. authTokenì´  ì„œë²„ê°€ ë°œê¸‰ í† í°ì´ ë§ëŠ”ì§€ ê²€ì¦
    const { userId } = jwt.verify(authToken, "customized-secret-key");

    // 3. authTokenì— ìˆëŠ” userIdì— í•´ë‹¹í•˜ëŠ” ì‚¬ìš©ìê°€ ì‹¤ì œ DBì— ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
    const user = await User.findById(userId);
    // í˜„ì¬ ì´ ë¯¸ë“¤ì›¨ì–´ ë‹¤ìŒìœ¼ë¡œ ë„˜ê¸°ê¸° ìœ„í•´ì„œ ìš°ì„  localsì•ˆì—ë‹¤ê°€ ìœ ì €ì •ë³´ë¥¼ ì „ë‹¬í•œë‹¤
    res.locals.user = user;
    next(); // ì´ ë¯¸ë“¤ì›¨ì–´ ë‹¤ìŒìœ¼ë¡œ ë³´ë‚¸ë‹¤
  } catch (error) {
    console.error(error);
    res.status(403).json({errorMessage: "ì „ë‹¬ëœ ì¿ í‚¤ì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤."});
    return;
  }
};
```

- auth-middleware.jsë¥¼ ì‘ì„±í•´ì„œ ìœ ì €ê°€ ë¡œê·¸ì¸ì‹œ ìë™ìœ¼ë¡œ Tokenì„ ìƒì„±í•˜ê²Œ í•´ì¤Œ
- ë¯¸ë“¤ì›¨ì–´ íŒŒì¼ ìì²´ì—ì„œ tokenì— ëŒ€í•œ ìœ íš¨ì„±ê²€ì‚¬ë¥¼ ì‘ì„±í•¨
- ë‹¤ë¥¸ íŒŒì¼ì—ì„œ const authMiddleware = require('../middlewares/auth-middleware');ë¡œ ê°€ì ¸ì™€ì„œ ë¯¸ë“¤ì›¨ì–´ ë‚´ìš©ì„ ë³€ìˆ˜ authMiddlewareì— ì €ì¥ í›„ ì‰½ê²Œ ì‚¬ìš©ì ì¸ì¦ì„ ë‹¤ë¥¸ apiì— ì†ì‰½ê²Œ ì‚¬ìš©í•¨

## GitHub ğŸ“˜

- https://github.com/junseok1925/Node.js_Board_backEnd
- https://github.com/junseok1925/TIL-WIL