## ì˜¤ëŠ˜ í•´ì•¼í•  ê²ƒ âœ…

- https://github.com/junseok1925/Board_Sequelize â†’ ëŒ“ê¸€ê¸°ëŠ¥ (Comments API)ì™„ì„±í•˜ê¸°, ê°€ëŠ¥í•˜ë©´ ì¢‹ì•„ìš”(Like API) ì‹œì‘
- ì‹¬í™”ì£¼ì°¨ ê°•ì˜ ë“£ê¸°

## ì˜¤ëŠ˜ í•™ìŠµëª©í‘œâœï¸

- ëŒ“ê¸€(Comments API) êµ¬í˜„
    1. ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒ API
        - ë¡œê·¸ì¸ í† í°ì„ ì „ë‹¬í•˜ì§€ ì•Šì•„ë„ ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒê°€ ê°€ëŠ¥í•˜ë„ë¡ í•˜ê¸°
        - ì¡°íšŒí•˜ëŠ” ê²Œì‹œê¸€ì— ì‘ì„±ëœ ëª¨ë“  ëŒ“ê¸€ì„ ëª©ë¡ í˜•ì‹ìœ¼ë¡œ ë³¼ ìˆ˜ ìˆë„ë¡ í•˜ê¸°
        - ì‘ì„± ë‚ ì§œ ê¸°ì¤€ìœ¼ë¡œ ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬í•˜ê¸°
    2. ëŒ“ê¸€ ì‘ì„± API
        - ë¡œê·¸ì¸ í† í°ì„ ê²€ì‚¬í•˜ì—¬, ìœ íš¨í•œ í† í°ì¼ ê²½ìš°ì—ë§Œ ëŒ“ê¸€ ì‘ì„± ê°€ëŠ¥
        - ëŒ“ê¸€ ë‚´ìš©ì„ ë¹„ì›Œë‘” ì±„ ëŒ“ê¸€ ì‘ì„± APIë¥¼ í˜¸ì¶œí•˜ë©´ "ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" ë¼ëŠ” ë©”ì„¸ì§€ë¥¼ returní•˜ê¸°
        - ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ëŒ“ê¸€ ì‘ì„± APIë¥¼ í˜¸ì¶œí•œ ê²½ìš° ì‘ì„±í•œ ëŒ“ê¸€ì„ ì¶”ê°€í•˜ê¸°
    3. ëŒ“ê¸€ ìˆ˜ì • API
        - ë¡œê·¸ì¸ í† í°ì„ ê²€ì‚¬í•˜ì—¬, í•´ë‹¹ ì‚¬ìš©ìê°€ ì‘ì„±í•œ ëŒ“ê¸€ë§Œ ìˆ˜ì • ê°€ëŠ¥
        - ëŒ“ê¸€ ë‚´ìš©ì„ ë¹„ì›Œë‘” ì±„ ëŒ“ê¸€ ìˆ˜ì • APIë¥¼ í˜¸ì¶œí•˜ë©´ "ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" ë¼ëŠ” ë©”ì„¸ì§€ë¥¼ returní•˜ê¸°
        - ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ê³  ëŒ“ê¸€ ìˆ˜ì • APIë¥¼ í˜¸ì¶œí•œ ê²½ìš° ì‘ì„±í•œ ëŒ“ê¸€ì„ ìˆ˜ì •í•˜ê¸°
    4. ëŒ“ê¸€ ì‚­ì œ API
        - ë¡œê·¸ì¸ í† í°ì„ ê²€ì‚¬í•˜ì—¬, í•´ë‹¹ ì‚¬ìš©ìê°€ ì‘ì„±í•œ ëŒ“ê¸€ë§Œ ì‚­ì œ ê°€ëŠ¥
        - ì›í•˜ëŠ” ëŒ“ê¸€ì„ ì‚­ì œí•˜ê¸°
    5. ê²Œì‹œê¸€ ì¢‹ì•„ìš” API
        - ë¡œê·¸ì¸ í† í°ì„ ê²€ì‚¬í•˜ì—¬, ìœ íš¨í•œ í† í°ì¼ ê²½ìš°ì—ë§Œ ê²Œì‹œê¸€ ì¢‹ì•„ìš” ê°€ëŠ¥
        - ë¡œê·¸ì¸ í† í°ì— í•´ë‹¹í•˜ëŠ” ì‚¬ìš©ìê°€ ì¢‹ì•„ìš” í•œ ê¸€ì— í•œí•´ì„œ, ì¢‹ì•„ìš” ì·¨ì†Œ í•  ìˆ˜ ìˆê²Œ í•˜ê¸°
        - ê²Œì‹œê¸€ ëª©ë¡ ì¡°íšŒì‹œ ê¸€ì˜ ì¢‹ì•„ìš” ê°¯ìˆ˜ë„ ê°™ì´ í‘œì¶œí•˜ê¸°
    6. ì¢‹ì•„ìš” ê²Œì‹œê¸€ ì¡°íšŒ API
        - ë¡œê·¸ì¸ í† í°ì„ ê²€ì‚¬í•˜ì—¬, ìœ íš¨í•œ í† í°ì¼ ê²½ìš°ì—ë§Œ ì¢‹ì•„ìš” ê²Œì‹œê¸€ ì¡°íšŒ ê°€ëŠ¥
        - ë¡œê·¸ì¸ í† í°ì— í•´ë‹¹í•˜ëŠ” ì‚¬ìš©ìê°€ ì¢‹ì•„ìš” í•œ ê¸€ì— í•œí•´ì„œ, ì¡°íšŒí•  ìˆ˜ ìˆê²Œ í•˜ê¸°
        - ì œëª©, ì‘ì„±ìëª…(nickname), ì‘ì„± ë‚ ì§œ, ì¢‹ì•„ìš” ê°¯ìˆ˜ë¥¼ ì¡°íšŒí•˜ê¸°
        - ì œì¼ ì¢‹ì•„ìš”ê°€ ë§ì€ ê²Œì‹œê¸€ì„ ë§¨ ìœ„ì— ì •ë ¬í•˜ê¸° (ë‚´ë¦¼ì°¨ìˆœ)

## í™˜ê²½ì„¸íŒ…

1. `npx sequelize db:create` 
    
    â†’ config.jsonì— ì„¤ì •ëœ ì½”ë“œë¥¼ ë°”íƒ•ìœ¼ë¡œ DBìƒì„± ( ì´ë¯¸ í”„ë¡œì íŠ¸ í™˜ê²½ ì„¸íŒ…í•  ë•Œ í•œë²ˆ í–ˆê¸° ë•Œë¬¸ì— ì•ˆí•´ë‘ëœë‹¤)
    
2. `npx sequelize model:generate --name Comments --attributes title:string,content:string,password:string`
    
    â†’ Commentsë¼ëŠ” ì´ë¦„ì˜ migrationíŒŒì¼ì„ ìƒì„±, ì»¬ëŸ¼ë¥¼ ì¶”ê°€í•˜ê³  ë‹¤ë¥¸ í…Œì´ë¸”ì˜ ì»¬ëŸ¼ê³¼ ê¸°ë³¸í‚¤ì„¤ì • í›„
    
    â†’ ìƒì„±ëœ migrationíŒŒì¼ ì½”ë“œë¥¼ ê¸°ë°˜ìœ¼ë¡œ í…Œì´ë¸” ìƒì„± (Comments)
    

```jsx
# ê°€ì¥ ìµœê·¼ì— ì‹¤í–‰í•œ db:migrateë¥¼ ì·¨ì†Œí•©ë‹ˆë‹¤
npx sequelize db:migrate:undo

# migrations í´ë”ì— ì¡´ì¬í•˜ëŠ” migration íŒŒì¼ì„ ê¸°ë°˜ìœ¼ë¡œ í…Œì´ë¸”ì„ ìƒì„±í•©ë‹ˆë‹¤.
npx sequelize db:migrate
```

1. `app.js` ì— router ì—°ê²°
    
    â†’ const commentsRouter = require("./routes/comments.router");
    
         app.use('/api', commentsRouter);
    

## ë¼ìš°í„° ì‘ì„±í•˜ê¸° comments.router.js

```jsx
const express = require("express");
const router = express.Router();
const authMiddleware = require("../middlewares/auth-middleware");
const { Comments } = require("../models");
// const { Posts} = require("../models");

// ==================================== ëŒ“ê¸€ ìƒì„±í•˜ê¸° ====================================
router.post("/posts/:postId/comments", authMiddleware, async (req, res) => {
  try {
    const postId = req.params.postId;
    const { userId, nickname } = res.locals.user;
    const { comment } = req.body;

    if (!postId) {
      return res
        .status(404)
        .json({ errorMessage: "ê²Œì‹œê¸€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." });
    }
    if (!comment) {
      return res
        .status(412)
        .json({ errorMessage: "ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤." });
    }

    const createComments = await Comments.create({
      postId,
      userId: userId,
      nickname: nickname,
      comment,
    });
    return res
      .status(201)
      .json({ message: "ëŒ“ê¸€ì„ ì‘ì„±í•˜ì˜€ìŠµë‹ˆë‹¤", data: createComments });
  } catch (error) {
    console.error(error);
    res.status(400).json({
      errorMessage: "ëŒ“ê¸€ ì‘ì„±ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.",
    });
  }
});

// ==================================== ëŒ“ê¸€ ëª©ë¡ ì¡°íšŒí•˜ê¸° ====================================
router.get("/posts/:postId/comments", authMiddleware, async (req, res) => {
  try {
    const postId = req.params.postId;

    if (!postId) {
      return res
        .status(404)
        .json({ errorMessage: "ê²Œì‹œê¸€ì´ ì¡´ì¬í•˜ì§€ì•ŠìŠµë‹ˆë‹¤." });
    }
    const comments = await Comments.findAll({
      attributes: [
        "commentId",
        "userId",
        "nickname",
        "comment",
        "createdAt",
        "updatedAt",
      ],
      where: { postId },
    });
    return res.status(200).json({ data: comments });
  } catch (error) {
    console.error(error);
    res.status(400).json({
      errorMessage: "ëŒ“ê¸€ ì¡°íšŒì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.",
    });
  }
});

// ==================================== ëŒ“ê¸€ ìˆ˜ì •í•˜ê¸° ====================================
router.put('/posts/:postId/comments/:commentId', authMiddleware, async (req, res) => {
  try {
    const { userId } = res.locals.user;
    const commentId = req.params.commentId;
    const postId = req.params.postId;
    const { comment } = req.body;

    if (!comment) {
      return res.status(412).json({
        message: 'ë°ì´í„° í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.',
      });
    }

    if (!postId) {
      return res.status(404).json({
        message: 'ê²Œì‹œê¸€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
      });
    }

    // Primary Key (ê¸°ë³¸ í‚¤)ë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • ë ˆì½”ë“œë¥¼ ì°¾ëŠ” ë©”ì„œë“œ. ì—¬ê¸°ì„œëŠ” commentIdë¥¼ ê¸°ë³¸ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬ ëŒ“ê¸€ì„ ì°¾ëŠ”ë‹¤.
    const getComment = await Comments.findByPk(commentId);
    if (!getComment) {
      return res.status(404).json({
        success: false,
        errorMessage: 'ëŒ“ê¸€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
      });
    }

    if (getComment.userId !== userId) {
      return res.status(403).json({
        success: false,
        errorMessage: 'í•´ë‹¹ ëŒ“ê¸€ì„ ìˆ˜ì •í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.',
      });
    }
    // Commentsì˜ ë°ì´í„°ì¤‘ commentIdê°€ ê°™ì€ ë°ì´í„°ì˜ commentê°’ì„ ì…ë ¥ê°’ìœ¼ë¡œ ì—…ë°ì´íŠ¸
    const [updateComments] = await Comments.update(
      { comment },
      { where: { commentId: commentId } }
    );

    if (updateComments === 0) {
      return res.status(400).json({
        success: false,
        errorMessage: 'ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.',
      });
    }

    const updatedComments = await Comments.findByPk(commentId);

    res.json({
      message: 'ëŒ“ê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.',
      ìˆ˜ì •ì™„ë£Œ: {
        comment: updatedComments.comment,
        createdAt: updatedComments.createdAt,
      },
    });
  } catch (error) {
    console.error(error);
    res.status(400).json({
      success: false,
      errorMessage: 'ëŒ“ê¸€ ìˆ˜ì •ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.',
    });
  }
});
// ==================================== ëŒ“ê¸€ ì‚­ì œí•˜ê¸° ====================================

router.delete("/posts/:postId/comments/:commentId", authMiddleware, async (req, res) => {
  try{
  const { userId } = res.locals.user;
  const  postId  = req.params.postId;
  const commentId= req.params.commentId;
  const comment = await Comments.findOne({where:{commentId}});

  if(!postId){
      return res.status(404).json({ errorMessage: "ê²Œì‹œë¬¼ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." });
  }
  if(!commentId){
    return res.status(404).json({ errorMessage: "ëŒ“ê¸€ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤." });
}
  if(userId !== comment.userId){
      return res.status(403).json({ errorMessage: "ëŒ“ê¸€ì„ ì‚­ì œì˜ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤." });
  }

  await Comments.destroy({where: {commentId}});
  res.status(200).json({message: "ëŒ“ê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤."});
  
} catch (error) {
  console.error(error);
  res.status(400).json({
    success: false,
    errorMessage: "ëŒ“ê¸€ ì‚­ì œì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.",
  });
}
});
module.exports = router;
```

- `const  postId  = req.params.postId;` ì²˜ëŸ¼ paramsì—ì„œ ì…ë ¥ëœ ê°’ì„ ê°€ì ¸ì˜¬ë• `{ }` ì¤‘ ê´„í˜¸ë¡œ ë¬¶ì§€ ë§ì
- `await Comments.destroy({where: {commentId}});` ì™€ ê°™ì€ ì¿¼ë¦¬ì ˆì— whereì¡°ê±´ì„ ì˜ ì ì

`findByPK()`  ê¸°ì–µí•˜ê¸°

```
// Primary Key (ê¸°ë³¸ í‚¤)ë¥¼ ì‚¬ìš©í•˜ì—¬ íŠ¹ì • ë ˆì½”ë“œë¥¼ ì°¾ëŠ” ë©”ì„œë“œ. ì—¬ê¸°ì„œëŠ” commentIdë¥¼ ê¸°ë³¸ í‚¤ë¡œ ì‚¬ìš©í•˜ì—¬ ëŒ“ê¸€ì„ ì°¾ëŠ”ë‹¤.
    const getComment = await Comments.findByPk(commentId);
    if (!getComment) {
      return res.status(404).json({
        success: false,
        errorMessage: 'ëŒ“ê¸€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.',
      });
    }
```

## GitHub ğŸ“˜

- https://github.com/junseok1925/Board_Sequelize
- https://github.com/junseok1925/TIL-WIL