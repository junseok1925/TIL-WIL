## ì˜¤ëŠ˜ í•´ì•¼í•  ê²ƒ âœ…

- acccesToken, refreshToken
- redis

## [16ì¡° ë¯¸ë‹ˆí”„ë¡œì íŠ¸ S.A ](https://www.notion.so/16-S-A-0c1308a4bf7e4b8b9cd467d306254bc0)

- ë¡¤ë§ í˜ì´í¼ êµ¬í˜„
- ì‚¬ìš©ìëŠ” íšŒì›ê°€ì…ê³¼ ë¡œê·¸ì¸ì„ í•´ì•¼ì§€ë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë‹¤
- ë¡¤ë§ í˜ì´í¼ì˜ ì¬ë¯¸ë¥¼ ìœ„í•´ ìƒëŒ€ë°©ì—ê²Œ ì“´ ëŒ“ê¸€ì€ ìˆ˜ì •, ì‚­ì œ ë¶ˆê°€ëŠ¥

## Token.js

```jsx
const jwt = require("jsonwebtoken");

const SECRET_KEY = "longlling-paper-key";
const tokenObject = {}; // Refresh Tokenì„ ì €ì¥í•  Object

// userIdë¥¼ ë§¤ê°œë³€ìˆ˜ë¡œ ë°›ì•„ ìƒˆë¡œìš´ accessTokenì™€ refreshTokenì„ ìƒì„±
// ë°˜í™˜ëœ ë³€ìˆ˜ë“¤ì€ ë¡œê·¸ì¸ ë° ì¸ì¦ ê³¼ì •ì—ì„œ ì¿ í‚¤ì— ì €ì¥ë˜ì–´ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ê°„ì˜ ì¸ì¦ì— í™œìš©
function setToken(userId) {
  const accessToken = createAccessToken(userId);
  const refreshToken = createRefreshToken();

  tokenObject[refreshToken] = userId; // Refresh Tokenì„ ê°€ì§€ê³  í•´ë‹¹ ìœ ì €ì˜ ì •ë³´ë¥¼ ì„œë²„ì— ì €ì¥í•©ë‹ˆë‹¤.

  return { accessToken, refreshToken };
}

// í•´ë‹¹ í•¨ìˆ˜ëŠ” userIdë¥¼ ì¸ìë¡œ ë°›ì•„ JWT(access token)ë¥¼ ìƒì„±í•˜ëŠ” í•¨ìˆ˜
// ìƒì„±ëœ JWTì—ëŠ” userIdê°€ ì €ì¥ë˜ê³  ë§Œë£Œì‹œê°„ì„ ì§€ì •
// 2h ë’¤ ë§Œë£Œ
function createAccessToken(userId) {
  return jwt.sign({ userId }, SECRET_KEY, { expiresIn: "2h" });
}
// ë¹ˆ ê°ì²´ {}ë¥¼ SECRET_KEYë¥¼ ì´ìš©í•´ JSON Web Tokenìœ¼ë¡œ ë³€í™˜
// 7ì¼ë’¤ ë§Œë£Œ
function createRefreshToken() {
  return jwt.sign({}, SECRET_KEY, { expiresIn: "7d" }); // Refresh Token 7ì¼ë’¤ ë§Œë£Œ
}
// accessTokenì´ ìœ íš¨í•œì§€ ê²€ì‚¬í•˜ê¸°
function validAccessToken(accessToken) {
  try {
    jwt.verify(accessToken, SECRET_KEY);
    return true;
  } catch (error) {
    return false;
  }
}

//refreshTokenì´ ìœ íš¨í•œì§€ ê²€ì‚¬í•˜ê¸°
function validRefreshToken(refreshToken) {
  try {
    jwt.verify(refreshToken, SECRET_KEY);
    return true;
  } catch (error) {
    return false;
  }
}
module.exports = {
  setToken,
  createAccessToken,
  createRefreshToken,
  validAccessToken,
  validRefreshToken,
};

// ì •ë¦¬
// 1. setToken í•¨ìˆ˜ê°€ ì‹¤í–‰.
// 2. userIdë¥¼ ì¸ìë¡œ ë°›ì•„ì„œ createAccessToken í•¨ìˆ˜ì™€ createRefreshToken í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•œë‹¤.
// 3. createAccessToken í•¨ìˆ˜ëŠ” userIdë¥¼ ì´ìš©í•´ accessTokenì„ ìƒì„±í•˜ê³ , expiresIn ì˜µì…˜ì„ ì´ìš©í•´ ë§Œë£Œì‹œê°„ì„ 10ì´ˆë¡œ ì„¤ì •ëœë‹¤.
// 4. createRefreshToken í•¨ìˆ˜ëŠ” ë¹ˆ ê°ì²´ {}ë¥¼ ì´ìš©í•´ refreshTokenì„ ìƒì„±í•˜ê³ , expiresIn ì˜µì…˜ì„ ì´ìš©í•´ ë§Œë£Œì‹œê°„ì„ 7ì¼ë¡œ ì„¤ì •ëœë‹¤.
// 5. setToken í•¨ìˆ˜ëŠ” ìƒì„±ëœ accessTokenê³¼ refreshTokenì„ ë°˜í™˜, refreshTokenì„ ì„œë²„ì— ì €ì¥í•˜ê¸° ìœ„í•´ tokenObject[refreshToken] = userId ì½”ë“œë¥¼ ì‹¤í–‰í•œë‹¤.
```

## auth-middleware.js

```jsx
const jwt = require("jsonwebtoken");
const { Users } = require("../models");
const {
  createAccessToken,
  validAccessToken,
  validRefreshToken,
} = require("./token");

module.exports = async (req, res, next) => {
  const { accessToken, refreshToken } = req.cookies;

  // null ë³‘í•© ë¬¸ìì—´ : ì™¼ìª½ì˜ ê°’ì´ ë¹„ì—ˆê±°ë‚˜ nullì¼ ê²½ìš° ì˜¤ë¥¸ìª½ ê°’ìœ¼ë¡œ ëŒ€ì¹˜í•´ì¤€ë‹¤
  // -> ê¸°ì¡´ì—” Bearerì¸ì¦ì„ ì‚¬ìš©í•´ì„œ í† í°ì„ ì „ë‹¬ ë°›ì•˜ì§€ë§Œ, ì´ì œëŠ” cookieë¥¼ ì‚¬ìš©í•´ì„œ accTokenê³¼ refTokenì„ ì „ë‹¬ ë°›ê¸°ë•Œë¬¸ì— í•„ìš”ì—†ë‹¤
  // const [authType, authToken] = (Authorization ?? "").split(" ");

  // ì—‘ì„¸ìŠ¤ í† í°ê³¼ ë¦¬í”„ë ˆì‹œ í† í°ì´ ëª¨ë‘ ì¡´ì¬í•˜ê³  ìˆëŠ”ì§€ í™• ì¦‰,ì—†ìœ¼ë©´ ë¡œê·¸ì¸ìƒíƒœê°€ ì•„ë‹˜
  if (!accessToken || !refreshToken) {
    res.status(403).json({
      errorMessage: "ë¡œê·¸ì¸ì´ í•„ìš”í•œ ê¸°ëŠ¥ì…ë‹ˆë‹¤.",
    });
    return; // ë‹¤ìŒ ì½”ë“œë¡œ ì§„í–‰ì„ ë§‰ëŠ”ë‹¤
  }

  // accessTokenì´ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´, refreshTokenì— ì €ì¥ëœ ì‚¬ìš©ì userIdë¥¼ ì´ìš©í•´ ìƒˆë¡œìš´ accessToken ìƒì„±í•´ì£¼ê¸°
  if (!validAccessToken(accessToken)) {
    const { userId } = jwt.verify(refreshToken, "longlling-paper-key");
    const newAccessToken = createAccessToken(userId);
    res.cookie("accessToken", newAccessToken);
  }

  // ë¦¬í”„ë ˆì‹œ í† í°ì´ ìœ íš¨í•œì§€ í™•ì¸
  if (!validRefreshToken(refreshToken)) {
    res.status(419).json({
      errorMessage: "Refresh Tokenì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.",
    });
    return;
  }

  try {
    // accessToken ê²€ì¦
    const { userId } = jwt.verify(accessToken, "longlling-paper-key");

    // DB userIdë¡œ ì‚¬ìš©ìê°€ ìˆëŠ”ì§€ í™•ì¸
    const user = await Users.findOne({ where: { userId } });
    res.locals.user = user;
    next();
  } catch (error) {
    console.error(error);
    res.status(403).json({ errorMessage: "ì „ë‹¬ëœ Tokenì— ì˜¤ë¥˜ê°€ ìˆìŠµë‹ˆë‹¤." });
    return;
  }
};
```

## login.router.js

- ë¡œê·¸ì¸ êµ¬í˜„ì—ì„œ jwtí† í°ì´ ì•„ë‹Œ ì´ì œ accessToken, refreshTokenì„ ë°œê¸‰

```jsx
router.post("/login", async (req, res) => {
  try {
    const { email, password } = req.body;
    const user = await Users.findOne({ where: { email } });

    // #412 í•´ë‹¹í•˜ëŠ” ìœ ì €ê°€ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°
    // nicknameê³¼ password ì˜ˆì™¸ì²˜ë¦¬ë¥¼ ë¬¶ì–´ì„œ í•œë²ˆì— í•˜ëŠ” ì´ìœ 
    // -> nicknameê³¼ passwordë¥¼ ë”°ë¡œ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ í•˜ë©´ í•´í‚¹ ë‹¹í•  í™•ë¥ ì´ ë†’ê¸° ë•Œë¬¸, ë‘˜ ì¤‘ ë¬´ì—‡ì´ ì˜¤ë¥˜ì¸ì§€ ì•Œë ¤ì£¼ì§€ì•ŠìŒ
    if (!user || user.password !== password) {
      res.status(412).json({
        errorMessage: "ì´ë©”ì¼ ë˜ëŠ” íŒ¨ìŠ¤ì›Œë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.",
      });
      return;
    }
      // setToken í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ì—¬ accessTokenê³¼ refreshTokenì„ ìƒì„±í•©ë‹ˆë‹¤.
      const { accessToken, refreshToken } = setToken(user.userId);

      res.cookie("accessToken", accessToken);
      res.cookie("refreshToken", refreshToken);

    return res.status(200).json({ message: "ë¡œê·¸ì¸ì— ì„±ê³µí–ˆìŠµë‹ˆë‹¤."}  );
  } catch (error) {
    console.error(error);
    res.status(400).json({
      errorMessage: "ë¡œê·¸ì¸ì— ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤.",
    });
  }
});
```

## GitHub ğŸ“˜

- https://github.com/junseok1925/Mini_Project_Longlling_Paper.git
- https://github.com/junseok1925/TIL-WIL